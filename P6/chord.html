<!DOCTYPE html>
<meta charset="utf-8">
<title>Busiest Airports' 2008 Delays</title>
<style>
  @import url(style.css);
  #circle circle {
    fill: none;
    pointer-events: all;
  }

  .group path {
    fill-opacity: .5;
  }

  path.chord {
    stroke: #000;
    stroke-width: .25px;
  }

  #circle:hover path.fade {
    display: none;
  }

  .chart {
  float: left;
  font: 10px sans-serif;
  padding: 20px;
  text-align: center;
  width: 340px;
}
</style>

<body>
  <h2>2008 Delays between Busiest Airports</h2>
  <p>Built with <a href="http://d3js.org/">d3.js</a>.

  <p>Mouseover to focus on a particular a airport.</p>

    <script src="http://d3js.org/d3.v2.min.js?2.8.1"></script>

    <script>
      var margin = {top: 20, right: 20, bottom: 30, left: 60},
        ww = document.body.clientWidth,
        width = ww - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;
        outerRadius = Math.min(width, height) / 2 - 10,
        innerRadius = outerRadius - 24;

      var formatPercent = d3.format(".1%");

      var arc = d3.svg.arc()
        .innerRadius(innerRadius)
        .outerRadius(outerRadius);

      var layout = d3.layout.chord()
        .padding(.04)
        .sortSubgroups(d3.descending)
        .sortChords(d3.ascending);

      var path = d3.svg.chord()
        .radius(innerRadius);

      var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("id", "circle")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

      svg.append("circle")
        .attr("r", outerRadius);

      d3.csv("data/airliners.csv", function(cities) {
        d3.json("data/matrix.json", function(matrix) {

          // Compute the chord layout.
          layout.matrix(matrix);

          // Add a group per neighborhood.
          var group = svg.selectAll(".group")
            .data(layout.groups)
            .enter().append("g")
            .attr("class", "group")
            .on("mouseover", mouseover);

          // Add a mouseover title.
          // group.append("title").text(function(d, i) {
          // return cities[i].name + ": " + formatPercent(d.value) + " of origins";
          // });

          // Add the group arc.
          var groupPath = group.append("path")
            .attr("id", function(d, i) {
              return "group" + i;
            })
            .attr("d", arc)
            .style("fill", function(d, i) {
              return cities[i].color;
            });

          // Add a text label.
          var groupText = group.append("text")
            .attr("x", 6)
            .attr("dy", 15);

          groupText.append("textPath")
            .attr("xlink:href", function(d, i) {
              return "#group" + i;
            })
            .text(function(d, i) {
              return cities[i].name;
            });

          // Remove the labels that don't fit. :(
          groupText.filter(function(d, i) {
            return groupPath[0][i].getTotalLength() / 2 - 16 <
              this.getComputedTextLength();
          }).remove();

          // Add the chords.
          var chord = svg.selectAll(".chord")
            .data(layout.chords)
            .enter().append("path")
            .attr("class", "chord")
            .style("fill", function(d) {
              return cities[d.source.index].color;
            })
            .attr("d", path);

          // Add an elaborate mouseover title for each chord.
          chord.append("title").text(function(d) {
            return cities[d.source.index].name + " → " +
                   cities[d.target.index].name + ": " +
                   d.source.value + " min" + "\n" +
                   cities[d.target.index].name + " → " +
                   cities[d.source.index].name + ": " +
                   d.target.value + " min";
          });

          function mouseover(d, i) {
            chord.classed("fade", function(p) {
              return p.source.index != i && p.target.index != i;
            });
          }
        });
      });
    </script>

    <h3>Interpreting the diagram</h3>
    <p>
      Chord diagrams present information using two sets elements: (1)
      a set of arcs around the outside of the diagram and (2) a set of chords
      or ribbons on the inside.
    </p>

    <p>
      The arc length shows the aggreated averaged delay. The chords show
      relations between arcs (airports).  Their width on either end is
      determined by the average delay between airpots. The color represent
      the direction in which delay is higher.
    </p>
</body>
